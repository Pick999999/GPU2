<!DOCTYPE html>
<html lang="en">
<!--
    ========================================================================================
    üìù ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (THAI MANUAL) - MultiAssetBundle Test Page
    ========================================================================================
    
    ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á MultiAssetBundle.js ‡∏ã‡∏∂‡πà‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    
    üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (Key Functions from MultiAssetBundle.js):
    
    1. new MultiAssetManager(appId)
       - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Instance ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
       - ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Deriv API ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° WebGPU
    
    2. manager.execute(params)
       - ***‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Core Function)***
       - ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ 2 ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:
         (1) Fetch Data: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô (Candles) ‡∏à‡∏≤‡∏Å Deriv API ‡∏ï‡∏≤‡∏° assets ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
         (2) Calculate Indicators: ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Technical Indicators (RSI, Choppy, EMA)
       
       - Parameters (params) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
         * assets: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡πÄ‡∏á‡∏¥‡∏ô/‡∏´‡∏∏‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ['R_10', 'R_25'])
         * latest: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á (‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
         * startDate, stopDate: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á)
         * duration: ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á Timeframe (‡πÄ‡∏ä‡πà‡∏ô 1, 5)
         * durationUnit: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ('m'=‡∏ô‡∏≤‡∏ó‡∏µ, 'h'=‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
         * useSuperKernel: ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ GPU Batch Processing (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)
         
    3. ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Returns)
       - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ object ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
         * result.assets: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Open, High, Low, Close) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
         * result.indicators: ‡∏Ñ‡πà‡∏≤ Indicators ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
         * result.stats: ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ, ‡πÇ‡∏´‡∏°‡∏î GPU, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
    
    ========================================================================================
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiAsset Bundle Test (TH)</title>
    <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ GPU.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠ -->
    <script src="https://cdn.jsdelivr.net/npm/gpu.js@latest/dist/gpu-browser.min.js"></script>
    <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Bundle ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô -->
    <script src="MultiAssetBundle.js"></script>
    <style>
        body {
            font-family: "Courier New", monospace;
            background: #0a0e27;
            color: #00ff88;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4a9eff;
            text-align: center;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .controls {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 8px;
        }

        .output-panel {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            max-height: 800px;
            overflow-y: auto;
            border: 1px solid #2a3654;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a9eff;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            background: #0f132a;
            border: 1px solid #2a3654;
            color: #fff;
            border-radius: 4px;
            font-family: inherit;
        }

        button {
            background: #4a9eff;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background: #357ab9;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-ok {
            background: #00ff88;
            color: #000;
        }

        .status-err {
            background: #ff4444;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #333;
            text-align: left;
        }

        th {
            color: #4a9eff;
        }

        tr:hover {
            background: #111;
        }
    </style>
</head>

<body>
    <h1>üì¶ MultiAsset Bundle Tester (Thai Commentary)</h1>

    <div class="container">
        <!-- Controls Panel -->
        <div class="controls">
            <div class="form-group">
                <label>App ID (‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏û)</label>
                <input type="text" id="appId" value="1089">
            </div>

            <div class="form-group">
                <label>Assets (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏π‡πà‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)</label>
                <textarea id="assets" rows="4">R_10, R_25, R_50, R_75, R_100, 1HZ10V, 1HZ25V</textarea>
            </div>

            <div class="row">
                <div class="form-group" style="flex:1">
                    <label>‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Mode)</label>
                    <select id="dataMode" onchange="toggleDateInputs()">
                        <option value="latest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Latest Count)</option>
                        <option value="range">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Date Range)</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ó‡πà‡∏á (Count)</label>
                    <input type="number" id="latestCount" value="1000">
                </div>
            </div>

            <div id="dateInputs" class="row" style="display:none;">
                <div class="form-group" style="flex:1">
                    <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (Start Date)</label>
                    <input type="datetime-local" id="startDate">
                </div>
                <div class="form-group" style="flex:1">
                    <label>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (End Date)</label>
                    <input type="datetime-local" id="endDate">
                </div>
            </div>

            <div class="row">
                <div class="form-group" style="flex:1">
                    <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ó‡πà‡∏á (Duration)</label>
                    <input type="number" id="duration" value="1">
                </div>
                <div class="form-group" style="flex:1">
                    <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Unit)</label>
                    <select id="durationUnit">
                        <option value="m">‡∏ô‡∏≤‡∏ó‡∏µ (Minutes)</option>
                        <option value="s">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (Seconds)</option>
                        <option value="h">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hours)</option>
                        <option value="d">‡∏ß‡∏±‡∏ô (Days)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="useSuperKernel" checked
                        style="width:20px; height:20px; margin-right:10px;">
                    Enable Super Kernel (GPU Batch)
                </label>
            </div>

            <button id="runBtn" onclick="runAnalysis()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Run Analysis)</button>
            <div id="statusMsg" style="margin-top:10px; text-align:center; color:#888;">Ready</div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <h3>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Results Output)</h3>
            <div id="tableContainer"></div>
            <hr style="border-color:#333; margin:20px 0;">
            <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Raw Log)</h3>
            <div id="logOutput"></div>
        </div>
    </div>

    <script>
        let manager = null;

        function log(msg, type = 'info') {
            const el = document.getElementById('logOutput');
            const color = type === 'error' ? '#ff4444' : (type === 'success' ? '#00ff88' : '#aaa');
            el.innerHTML += `<div style="color:${color}; margin-bottom:4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function toggleDateInputs() {
            const mode = document.getElementById('dataMode').value;
            const dateInputs = document.getElementById('dateInputs');
            const latestInput = document.getElementById('latestCount').parentElement;

            if (mode === 'range') {
                dateInputs.style.display = 'flex';
                latestInput.style.display = 'none';
            } else {
                dateInputs.style.display = 'none';
                latestInput.style.display = 'block';
            }
        }

        async function runAnalysis() {
            const btn = document.getElementById('runBtn');
            const status = document.getElementById('statusMsg');
            const appId = document.getElementById('appId').value;

            btn.disabled = true;
            status.textContent = "Initializing & Loading...";
            document.getElementById('logOutput').innerHTML = "";
            document.getElementById('tableContainer').innerHTML = "";

            try {
                if (!manager) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Manager Instance
                    manager = new MultiAssetManager(appId);
                }

                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Prepare Parameters)
                const rawAssets = document.getElementById('assets').value;
                const assets = rawAssets.split(',').map(s => s.trim()).filter(s => s.length > 0);

                const duration = parseInt(document.getElementById('duration').value);
                const durationUnit = document.getElementById('durationUnit').value;
                const useSuperKernel = document.getElementById('useSuperKernel').checked;
                const dataMode = document.getElementById('dataMode').value;

                let params = {
                    assets: assets,
                    duration: duration,
                    durationUnit: durationUnit,
                    useSuperKernel: useSuperKernel
                };

                if (dataMode === 'range') {
                    const startVal = document.getElementById('startDate').value;
                    const endVal = document.getElementById('endDate').value;

                    if (!startVal) throw new Error("Start Date is required for Range mode");

                    params.startDate = new Date(startVal);
                    if (endVal) params.stopDate = new Date(endVal);
                } else {
                    params.latest = parseInt(document.getElementById('latestCount').value);
                }

                log(`Starting Analysis for ${assets.length} assets...`);
                log(`Params: ${JSON.stringify(params)}`);

                const startTime = performance.now();

                // =========================================================================
                // üî¥ ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (Main Execution Call) üî¥
                // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (manager.execute) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
                // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fetching Data): MultiAssetLoader ‡∏à‡∏∞‡∏î‡∏∂‡∏á Candle ‡∏à‡∏≤‡∏Å Deriv
                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Calculating): WebGPUIndicators ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì EMA, RSI, Choppy
                // =========================================================================
                const result = await manager.execute(params);

                const endTime = performance.now();

                const timeTaken = (endTime - startTime).toFixed(2);
                status.textContent = `Completed in ${timeTaken}ms`;

                if (result.success) {
                    log(`‚úÖ Success! Time: ${timeTaken}ms`, 'success');
                    displayResults(result);
                } else {
                    log(`‚ùå Failure: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error(error);
                log(`‚ùå Error: ${error.message}`, 'error');
                status.textContent = "Error occurred";
            } finally {
                btn.disabled = false;
            }
        }

        function displayResults(result) {
            const container = document.getElementById('tableContainer');
            if (!result.assets || !result.indicators) return;

            let html = `
                <div style="margin-bottom:10px; font-size:14px;">
                    <span>GPU Mode: <strong style="color:#00ff88">${result.stats.gpuMode}</strong></span> | 
                    <span>Loaded: ${result.stats.loaded}</span> | 
                    <span>Failed: ${result.stats.failed}</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Symbol (‡∏ä‡∏∑‡πà‡∏≠)</th>
                            <th>Candles (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ó‡πà‡∏á)</th>
                            <th>Last Close (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                            <th>RSI (14)</th>
                            <th>Choppy (14)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(result.assets).forEach(symbol => {
                const asset = result.assets[symbol];
                const ind = result.indicators[symbol];

                if (!asset || !ind) return;

                const lastClose = asset.closes[asset.closes.length - 1]?.toFixed(4) || "N/A";
                const lastRSI = ind.rsi[ind.rsi.length - 1]?.toFixed(2) || "N/A";
                const lastChop = ind.choppy[ind.choppy.length - 1]?.toFixed(2) || "N/A";

                html += `
                    <tr>
                        <td><strong>${symbol}</strong></td>
                        <td>${asset.closes.length}</td>
                        <td>${lastClose}</td>
                        <td style="color:${parseFloat(lastRSI) > 70 ? '#ff4444' : (parseFloat(lastRSI) < 30 ? '#00ff88' : '#fff')}">${lastRSI}</td>
                        <td style="color:${parseFloat(lastChop) < 38 ? '#00ff88' : (parseFloat(lastChop) > 61.8 ? '#ff4444' : '#fff')}">${lastChop}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default Dates
        const now = new Date();
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);

        const toLocalISO = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().slice(0, 16);
        };

        document.getElementById('startDate').value = toLocalISO(yesterday);
        document.getElementById('endDate').value = toLocalISO(now);
    </script>
</body>

</html>